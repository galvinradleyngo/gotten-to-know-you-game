<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gotten to Know You Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            height: 100vh;
            width: 100vw;
        }
        html {
            height: 100%;
            overflow: hidden;
        }
        #app {
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            position: fixed;
            top: 0;
            left: 0;
        }
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 24px;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .game-screen {
            height: 100vh;
            width: 100vw;
            overflow-y: auto;
            overflow-x: hidden;
            position: fixed;
            top: 0;
            left: 0;
        }
        .no-scroll {
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            position: fixed;
            top: 0;
            left: 0;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="loading">
            <div class="text-center">
                <h1 class="text-4xl font-bold mb-4">üéÆ Gotten to Know You!</h1>
                <div class="flex items-center justify-center">
                    <p class="text-xl">Loading game...</p>
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('üéÆ Game starting - Clean Build...');
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDU32POTx2DzJoijpyMiv-yZHRJQAH1foA",
            authDomain: "gotten-to-know-you.firebaseapp.com",
            databaseURL: "https://gotten-to-know-you-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "gotten-to-know-you",
            storageBucket: "gotten-to-know-you.firebasestorage.app",
            messagingSenderId: "553283770730",
            appId: "1:553283770730:web:41c81f52de885116b0ed13"
        };
        
        // Game state variables
        let gameCode = '';
        let currentGame = null;
        let score = 0;
        let currentQuestion = 0;
        let studentAnswerSubmitted = false;
        let studentCurrentQuestion = 0; // Track student's current question separately
        
        // Firebase operations
        async function saveGameToFirebase(code, data) {
            try {
                const response = await fetch(`${firebaseConfig.databaseURL}/games/${code}.json`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                return response.ok;
            } catch (error) {
                console.log('Firebase save error:', error.message);
                return false;
            }
        }
        
        async function loadGameFromFirebase(code) {
            try {
                const response = await fetch(`${firebaseConfig.databaseURL}/games/${code}.json`);
                if (response.ok) {
                    const data = await response.json();
                    if (data !== null) {
                        if (!data.code) data.code = code;
                        return data;
                    }
                }
            } catch (error) {
                console.log('Firebase load error:', error.message);
            }
            return null;
        }
        
        // Utility functions
        function generateGameCode() {
            return Math.random().toString(36).substr(2, 6).toUpperCase();
        }
        
        function showError(elementId, message) {
            const errorEl = document.getElementById(elementId);
            if (errorEl) {
                errorEl.textContent = message;
                errorEl.classList.remove('hidden');
                setTimeout(() => errorEl.classList.add('hidden'), 5000);
            }
        }
        
        function getOptionLetter(index) {
            return String.fromCharCode(65 + index); // A, B, C, D
        }
        
        function getOptionColor(index) {
            const colors = [
                'from-red-500 to-red-600',
                'from-blue-500 to-blue-600',
                'from-green-500 to-green-600',
                'from-yellow-500 to-yellow-600'
            ];
            return colors[index] || 'from-gray-500 to-gray-600';
        }
        
        // Main menu
        function renderMenu() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="no-scroll bg-gradient-to-br from-purple-600 via-pink-600 to-blue-600 flex items-center justify-center p-4">
                    <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full text-center">
                        <div class="mb-8">
                            <div class="bg-gradient-to-r from-purple-500 to-pink-500 rounded-full w-20 h-20 flex items-center justify-center mx-auto mb-4 text-4xl">
                                üë•
                            </div>
                            <h1 class="text-3xl font-bold text-gray-800 mb-2">Gotten to Know You!</h1>
                            <p class="text-lg text-purple-600 font-semibold mb-2">A quiz game about you</p>
                            <p class="text-gray-600">A fun classroom game to learn about each other</p>
                        </div>
                        
                        <div class="space-y-4">
                            <button onclick="startTeacherFlow()" class="w-full bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 text-white font-semibold py-4 px-6 rounded-2xl transition-all duration-300 transform hover:scale-105 shadow-lg">
                                üéì I'm a Teacher
                            </button>
                            
                            <button onclick="startStudentFlow()" class="w-full bg-gradient-to-r from-green-500 to-teal-500 hover:from-green-600 hover:to-teal-600 text-white font-semibold py-4 px-6 rounded-2xl transition-all duration-300 transform hover:scale-105 shadow-lg">
                                üéí I'm a Student
                            </button>
                        </div>
                        
                        <div class="mt-6 text-xs text-gray-500">
                            Clean Build v1.0
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Teacher flow
        function startTeacherFlow() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="no-scroll bg-gradient-to-br from-blue-600 via-purple-600 to-pink-600 flex items-center justify-center p-4">
                    <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full text-center">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Create New Game</h2>
                        <p class="text-gray-600 mb-8">Click below to create a new game and get your game code!</p>
                        
                        <button onclick="createGame()" class="w-full bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 text-white font-semibold py-4 px-6 rounded-2xl transition-all duration-300 transform hover:scale-105 shadow-lg mb-4">
                            üéÆ Create Game
                        </button>
                        
                        <button onclick="renderMenu()" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-700 font-semibold py-3 px-6 rounded-2xl transition-all duration-300">
                            ‚Üê Back to Menu
                        </button>
                        
                        <div id="create-error" class="hidden mt-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-2xl"></div>
                    </div>
                </div>
            `;
        }
        
        async function createGame() {
            gameCode = generateGameCode();
            currentGame = {
                code: gameCode,
                players: [],
                isStarted: false,
                gamePhase: 'waiting',
                createdAt: new Date().toISOString()
            };
            
            const saved = await saveGameToFirebase(gameCode, currentGame);
            if (saved) {
                showTeacherDashboard();
            } else {
                showError('create-error', 'Failed to create game');
            }
        }
        
        function showTeacherDashboard() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="game-screen bg-gradient-to-br from-blue-600 via-purple-600 to-pink-600 p-4">
                    <div class="max-w-4xl mx-auto">
                        <div class="bg-gradient-to-r from-purple-500 to-pink-500 rounded-2xl shadow-xl p-4 mb-4 text-center">
                            <h1 class="text-2xl font-bold text-white mb-1">üéÆ Gotten to Know You!</h1>
                            <p class="text-sm text-purple-100">A Fun Classroom Game</p>
                        </div>
                        
                        <div class="bg-white rounded-2xl shadow-xl p-6">
                            <div class="text-center mb-6">
                                <h2 class="text-2xl font-bold text-gray-800 mb-4">Teacher Dashboard</h2>
                                <div class="bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-4 py-2 rounded-xl inline-block text-lg font-bold mb-4">
                                    Game Code: ${gameCode}
                                </div>
                                
                                <div class="bg-green-100 border border-green-400 text-green-800 px-3 py-2 rounded-xl mb-4 text-sm">
                                    ‚úÖ Game Active - Students can join!
                                </div>
                            </div>
                            
                            <div class="mb-6">
                                <h3 class="text-lg font-semibold text-gray-700 mb-3">Players (<span id="player-count">0</span>)</h3>
                                <div id="players-list" class="space-y-2">
                                    <div class="bg-gray-100 p-3 rounded-xl text-center text-gray-500 text-sm">
                                        Waiting for players to join...
                                    </div>
                                </div>
                            </div>
                            
                            <div class="text-center space-y-3">
                                <button id="start-game" onclick="startGame()" class="bg-gradient-to-r from-green-500 to-teal-500 hover:from-green-600 hover:to-teal-600 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-300 shadow-lg" disabled>
                                    üöÄ Start Game (Need 2+ Players)
                                </button>
                                
                                <br>
                                <button onclick="renderMenu()" class="bg-gray-300 hover:bg-gray-400 text-gray-700 font-semibold py-2 px-4 rounded-xl transition-all duration-300">
                                    ‚Üê Back to Menu
                                </button>
                            </div>
                        </div>
                        
                        <div class="text-center mt-4 text-white text-xs">
                            <p>Designed with Claude.ai by Galvin Ngo. For any feedback, email gngo@ateneo.edu</p>
                        </div>
                    </div>
                </div>
            `;
            
            checkForPlayers();
        }
        
        async function checkForPlayers() {
            const latestGame = await loadGameFromFirebase(gameCode);
            if (latestGame && latestGame.players) {
                currentGame = latestGame;
                const players = latestGame.players;
                
                // Check if elements exist before updating them
                const playerCountEl = document.getElementById('player-count');
                const listEl = document.getElementById('players-list');
                const startBtn = document.getElementById('start-game');
                
                if (playerCountEl) {
                    playerCountEl.textContent = players.length;
                }
                
                if (listEl) {
                    if (players.length === 0) {
                        listEl.innerHTML = `<div class="bg-gray-100 p-3 rounded-xl text-center text-gray-500 text-sm">Waiting for players to join...</div>`;
                    } else {
                        listEl.innerHTML = players.map(player => `
                            <div class="bg-gradient-to-r from-green-100 to-blue-100 p-3 rounded-xl border border-green-200">
                                <div class="flex items-center">
                                    <span class="mr-3 text-lg">‚úÖ</span>
                                    <div>
                                        <p class="font-semibold text-gray-800">${player.name}</p>
                                        <p class="text-xs text-gray-500">Joined: ${new Date(player.joinedAt).toLocaleTimeString()}</p>
                                    </div>
                                </div>
                            </div>
                        `).join('');
                    }
                }
                
                if (startBtn) {
                    if (players.length >= 2) {
                        startBtn.disabled = false;
                        startBtn.textContent = 'üöÄ Start Game!';
                    } else {
                        startBtn.disabled = true;
                        startBtn.textContent = `üöÄ Start Game (Need ${2 - players.length} more players)`;
                    }
                }
            }
            
            // Only continue checking if we're still on the teacher dashboard
            if (document.getElementById('player-count')) {
                setTimeout(checkForPlayers, 3000);
            }
        }
        
        async function startGame() {
            if (!currentGame.players || currentGame.players.length < 2) {
                alert('Need at least 2 players to start!');
                return;
            }
            
            // Generate questions from player facts
            const gameQuestions = generateQuestions(currentGame.players);
            
            // Update game state
            currentGame.isStarted = true;
            currentGame.gamePhase = 'playing';
            currentGame.questions = gameQuestions;
            currentGame.playerScores = {}; // Track scores for each player
            
            // Initialize scores for all players
            currentGame.players.forEach(player => {
                currentGame.playerScores[player.id] = {
                    name: player.name,
                    score: 0,
                    questionsAnswered: 0,
                    answers: {} // Store answers for each question
                };
            });
            
            await saveGameToFirebase(gameCode, currentGame);
            showTeacherLeaderboard();
        }
        
        function showTeacherLeaderboard() {
            const app = document.getElementById('app');
            
            app.innerHTML = `
                <div class="game-screen bg-gradient-to-br from-purple-600 via-pink-600 to-red-600 p-3">
                    <div class="max-w-6xl mx-auto h-full flex flex-col">
                        <div class="bg-gradient-to-r from-purple-500 to-pink-500 rounded-xl shadow-lg p-2 mb-2 text-center flex-shrink-0">
                            <h1 class="text-lg font-bold text-white">üéÆ Gotten to Know You! - Live Leaderboard</h1>
                        </div>
                        
                        <div class="bg-white rounded-xl shadow-xl p-4 flex-1 overflow-y-auto">
                            <div class="text-center mb-4">
                                <div class="flex justify-between items-center mb-3">
                                    <div class="bg-gradient-to-r from-blue-500 to-purple-500 text-white px-3 py-1 rounded-lg text-sm font-bold">
                                        ${currentGame.questions.length} Questions Total
                                    </div>
                                    <div class="bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-3 py-1 rounded-lg text-sm font-bold">
                                        Code: ${gameCode}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <h2 class="text-xl font-bold text-center text-gray-800 mb-3">üèÜ Live Leaderboard</h2>
                                <div id="leaderboard" class="space-y-2">
                                    <div class="bg-gray-100 p-4 rounded-xl text-center text-gray-500">
                                        Waiting for students to start answering...
                                    </div>
                                </div>
                            </div>
                            
                            <div class="text-center space-y-2">
                                <div class="bg-blue-50 p-3 rounded-lg">
                                    <p class="text-sm font-semibold text-blue-800">Students are answering at their own pace</p>
                                    <p class="text-xs text-blue-600">Leaderboard updates automatically every 2 seconds</p>
                                </div>
                                
                                <div class="flex justify-center space-x-2">
                                    <button onclick="endGame()" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg text-sm">
                                        üõë End Game
                                    </button>
                                    <button onclick="renderMenu()" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-3 rounded-lg text-sm">
                                        üè† New Game
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-center mt-2 text-white text-xs flex-shrink-0">
                            <p>Designed with Claude.ai by Galvin Ngo. For any feedback, email gngo@ateneo.edu</p>
                        </div>
                    </div>
                </div>
            `;
            
            updateLeaderboard();
        }
        
        async function updateLeaderboard() {
            const latestGame = await loadGameFromFirebase(gameCode);
            
            if (latestGame && latestGame.playerScores) {
                currentGame = latestGame;
                
                // Convert scores object to array and sort by score
                const sortedPlayers = Object.values(latestGame.playerScores)
                    .sort((a, b) => {
                        if (b.score !== a.score) return b.score - a.score; // Higher score first
                        return b.questionsAnswered - a.questionsAnswered; // More questions answered first
                    });
                
                const leaderboardEl = document.getElementById('leaderboard');
                if (leaderboardEl) {
                    if (sortedPlayers.length === 0 || sortedPlayers.every(p => p.questionsAnswered === 0)) {
                        leaderboardEl.innerHTML = `
                            <div class="bg-gray-100 p-4 rounded-xl text-center text-gray-500">
                                Waiting for students to start answering...
                            </div>
                        `;
                    } else {
                        leaderboardEl.innerHTML = sortedPlayers.map((player, index) => {
                            const rank = index + 1;
                            const percentage = latestGame.questions.length > 0 ? 
                                Math.round((player.score / latestGame.questions.length) * 100) : 0;
                            
                            let rankEmoji = 'üèÖ';
                            if (rank === 1) rankEmoji = 'ü•á';
                            else if (rank === 2) rankEmoji = 'ü•à';
                            else if (rank === 3) rankEmoji = 'ü•â';
                            
                            return `
                                <div class="bg-gradient-to-r from-yellow-50 to-orange-50 p-4 rounded-xl border-2 border-yellow-200">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center">
                                            <span class="text-2xl mr-3">${rankEmoji}</span>
                                            <div>
                                                <p class="text-lg font-bold text-gray-800">#${rank} ${player.name}</p>
                                                <p class="text-sm text-gray-600">Progress: ${player.questionsAnswered}/${latestGame.questions.length} questions</p>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-2xl font-bold text-orange-600">${player.score}</div>
                                            <div class="text-sm text-gray-600">${percentage}% correct</div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }
                }
            }
            
            // Continue updating if still on leaderboard screen
            if (document.getElementById('leaderboard')) {
                setTimeout(updateLeaderboard, 2000);
            }
        }
        
        function generateQuestions(players) {
            return players.map((player, index) => {
                const otherPlayers = players.filter(p => p.id !== player.id);
                const wrongAnswers = otherPlayers
                    .sort(() => 0.5 - Math.random())
                    .slice(0, Math.min(3, otherPlayers.length));
                
                const allOptions = [player, ...wrongAnswers]
                    .sort(() => 0.5 - Math.random());
                
                return {
                    questionNumber: index + 1,
                    fact: player.fact,
                    correctAnswer: player.name,
                    correctId: player.id,
                    options: allOptions.map(p => p.name),
                    correctIndex: allOptions.findIndex(p => p.id === player.id)
                };
            });
        }
        
        function showTeacherQuestion() {
            const question = currentGame.questions[currentGame.currentQuestion];
            const app = document.getElementById('app');
            
            app.innerHTML = `
                <div class="game-screen bg-gradient-to-br from-purple-600 via-pink-600 to-red-600 p-3">
                    <div class="max-w-6xl mx-auto h-full flex flex-col">
                        <div class="bg-gradient-to-r from-purple-500 to-pink-500 rounded-xl shadow-lg p-2 mb-2 text-center flex-shrink-0">
                            <h1 class="text-lg font-bold text-white">üéÆ Gotten to Know You!</h1>
                        </div>
                        
                        <div class="bg-white rounded-xl shadow-xl p-4 flex-1 overflow-y-auto">
                            <div class="text-center mb-4">
                                <div class="flex justify-between items-center mb-3">
                                    <div class="bg-gradient-to-r from-blue-500 to-purple-500 text-white px-3 py-1 rounded-lg text-sm font-bold">
                                        Question ${currentGame.currentQuestion + 1}/${currentGame.questions.length}
                                    </div>
                                    <div id="timer-display" class="w-12 h-12 rounded-full flex items-center justify-center text-lg font-bold bg-gradient-to-r from-green-400 to-blue-500 text-white">
                                        ${currentGame.timeLeft}
                                    </div>
                                    <div class="bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-3 py-1 rounded-lg text-sm font-bold">
                                        Code: ${gameCode}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <h2 class="text-xl font-bold text-center text-gray-800 mb-3">Who wrote this fun fact?</h2>
                                <div class="bg-gradient-to-br from-yellow-100 via-orange-100 to-pink-100 p-4 rounded-xl border-2 border-yellow-300 shadow-md text-center">
                                    <div class="bg-white bg-opacity-90 p-3 rounded-lg border border-yellow-200">
                                        <div class="text-2xl mb-2">üí≠</div>
                                        <p class="text-lg text-gray-900 italic font-semibold">"${question.fact}"</p>
                                        <div class="mt-2 text-lg">‚ú®</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-3 mb-4">
                                ${question.options.map((option, index) => `
                                    <div class="bg-gradient-to-r ${getOptionColor(index)} ${currentGame.showAnswer && index === question.correctIndex ? 'ring-4 ring-green-400 ring-opacity-70' : ''} p-3 rounded-lg text-center">
                                        <div class="text-xl font-bold text-white mb-1">${getOptionLetter(index)} ${currentGame.showAnswer && index === question.correctIndex ? '‚úÖ' : ''}</div>
                                        <div class="text-sm font-semibold text-white">${option}</div>
                                        ${currentGame.showAnswer && index === question.correctIndex ? '<div class="text-xs font-bold text-green-200 mt-1">CORRECT!</div>' : ''}
                                    </div>
                                `).join('')}
                            </div>
                            
                            <div class="text-center space-y-2">
                                <div class="bg-gray-100 p-2 rounded-lg">
                                    <p class="text-sm font-semibold text-gray-700">Students are answering...</p>
                                    <p class="text-xs text-gray-600">Timer: ${currentGame.timeLeft}s remaining</p>
                                </div>
                                
                                <div class="flex justify-center space-x-2">
                                    ${!currentGame.showAnswer ? `
                                        <button onclick="revealAnswer()" class="bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 text-white font-semibold py-2 px-4 rounded-lg">
                                            üëÅÔ∏è Reveal Answer
                                        </button>
                                    ` : `
                                        <button id="next-question-btn" onclick="nextQuestion()" class="bg-gradient-to-r from-green-500 to-teal-500 hover:from-green-600 hover:to-teal-600 text-white font-semibold py-2 px-4 rounded-lg">
                                            ‚û°Ô∏è Next Question
                                        </button>
                                    `}
                                    <button onclick="endGame()" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-3 rounded-lg text-sm">
                                        üõë End Game
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-center mt-2 text-white text-xs flex-shrink-0">
                            <p>Designed with Claude.ai by Galvin Ngo. For any feedback, email gngo@ateneo.edu</p>
                        </div>
                    </div>
                </div>
            `;
            
            startQuestionTimer();
        }
        
        async function revealAnswer() {
            console.log('üëÅÔ∏è Teacher revealing answer');
            currentGame.showAnswer = true;
            await saveGameToFirebase(gameCode, currentGame);
            showTeacherQuestion(); // Re-render to show the revealed answer
        }
        
        function startQuestionTimer() {
            const timer = setInterval(async () => {
                currentGame.timeLeft--;
                
                const timerEl = document.getElementById('timer-display');
                
                if (timerEl) {
                    timerEl.textContent = currentGame.timeLeft;
                    if (currentGame.timeLeft <= 5) {
                        timerEl.className = 'w-12 h-12 rounded-full flex items-center justify-center text-lg font-bold bg-red-500 text-white';
                    }
                }
                
                // Update game state for students
                await saveGameToFirebase(gameCode, currentGame);
                
                if (currentGame.timeLeft <= 0) {
                    clearInterval(timer);
                    // Don't auto-reveal - let teacher control it
                    console.log('‚è∞ Time up! Waiting for teacher to reveal answer...');
                }
            }, 1000);
        }
        
        async function nextQuestion() {
            currentQuestion++;
            currentGame.currentQuestion = currentQuestion;
            
            if (currentQuestion >= currentGame.questions.length) {
                await endGame();
                return;
            }
            
            // Reset for next question
            currentGame.timeLeft = 15;
            currentGame.showAnswer = false;
            studentAnswerSubmitted = false;
            
            await saveGameToFirebase(gameCode, currentGame);
            showTeacherQuestion();
        }
        
        async function endGame() {
            currentGame.gamePhase = 'finished';
            await saveGameToFirebase(gameCode, currentGame);
            
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="game-screen bg-gradient-to-br from-yellow-600 via-orange-600 to-red-600 p-4">
                    <div class="max-w-4xl mx-auto">
                        <div class="bg-gradient-to-r from-purple-500 to-pink-500 rounded-2xl shadow-xl p-4 mb-4 text-center">
                            <h1 class="text-2xl font-bold text-white mb-1">üéÆ Gotten to Know You!</h1>
                            <p class="text-sm text-purple-100">Game Complete!</p>
                        </div>
                        
                        <div class="bg-white rounded-2xl shadow-xl p-6">
                            <div class="text-center mb-6">
                                <div class="text-6xl mb-4">üéâ</div>
                                <h2 class="text-3xl font-bold text-gray-800 mb-4">Game Complete!</h2>
                                <p class="text-lg text-gray-600">Thank you for playing!</p>
                            </div>
                            
                            <div class="text-center">
                                <button onclick="renderMenu()" class="bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-semibold py-4 px-8 rounded-2xl transition-all duration-300 transform hover:scale-105 shadow-lg">
                                    üè† Create New Game
                                </button>
                            </div>
                        </div>
                        
                        <div class="text-center mt-4 text-white text-xs">
                            <p>Designed with Claude.ai by Galvin Ngo. For any feedback, email gngo@ateneo.edu</p>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Student flow
        function startStudentFlow() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="no-scroll bg-gradient-to-br from-green-600 via-teal-600 to-blue-600 flex items-center justify-center p-4">
                    <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full text-center">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Join Game</h2>
                        
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Game Code</label>
                                <input type="text" id="game-code-input" placeholder="Enter game code" class="w-full px-4 py-3 border-2 border-gray-300 rounded-2xl focus:border-blue-500 focus:outline-none text-center text-lg font-semibold uppercase" maxlength="6">
                            </div>
                            
                            <button onclick="joinGame()" class="w-full bg-gradient-to-r from-green-500 to-teal-500 hover:from-green-600 hover:to-teal-600 text-white font-semibold py-4 px-6 rounded-2xl transition-all duration-300 transform hover:scale-105 shadow-lg">
                                üéØ Join Game
                            </button>
                            
                            <div id="join-error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-2xl"></div>
                        </div>
                        
                        <button onclick="renderMenu()" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-700 font-semibold py-3 px-6 rounded-2xl transition-all duration-300 mt-4">
                            ‚Üê Back to Menu
                        </button>
                    </div>
                </div>
            `;
            
            const input = document.getElementById('game-code-input');
            input.addEventListener('input', (e) => {
                e.target.value = e.target.value.toUpperCase();
            });
        }
        
        async function joinGame() {
            console.log('üéØ Join game clicked');
            const input = document.getElementById('game-code-input');
            const code = input.value.trim().toUpperCase();
            
            console.log('Attempting to join with code:', code);
            
            if (!code || code.length !== 6) {
                showError('join-error', 'Please enter a valid 6-character game code');
                return;
            }
            
            try {
                const game = await loadGameFromFirebase(code);
                console.log('Game lookup result:', game);
                
                if (game) {
                    gameCode = code;
                    currentGame = game;
                    console.log('‚úÖ Game found, showing join success');
                    showJoinSuccess();
                } else {
                    console.log('‚ùå Game not found');
                    showError('join-error', 'Game not found. Please check the code.');
                }
            } catch (error) {
                console.error('‚ùå Error joining game:', error);
                showError('join-error', 'Error joining game. Please try again.');
            }
        }
        
        function showJoinSuccess() {
            console.log('üìù Showing join success screen');
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="no-scroll bg-gradient-to-br from-green-600 via-teal-600 to-blue-600 flex items-center justify-center p-4">
                    <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full text-center">
                        <div class="text-6xl mb-4">üéâ</div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Game Found!</h2>
                        <p class="text-lg text-gray-600 mb-6">Enter your information to join</p>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Your Name</label>
                                <input type="text" id="student-name" placeholder="Enter your name" class="w-full px-4 py-3 border-2 border-gray-300 rounded-2xl focus:border-blue-500 focus:outline-none" maxlength="30">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Fun Fact About You</label>
                                <textarea id="student-fact" placeholder="Share something interesting..." class="w-full px-4 py-3 border-2 border-gray-300 rounded-2xl focus:border-blue-500 focus:outline-none resize-none h-20" maxlength="150"></textarea>
                            </div>
                            
                            <button onclick="submitStudentInfo()" class="w-full bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 text-white font-semibold py-4 px-6 rounded-2xl transition-all duration-300 transform hover:scale-105 shadow-lg">
                                ‚úÖ Join Game
                            </button>
                            
                            <div id="submit-error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-2xl"></div>
                        </div>
                        
                        <button onclick="renderMenu()" class="mt-4 bg-gray-300 hover:bg-gray-400 text-gray-700 font-semibold py-2 px-4 rounded-2xl transition-all duration-300">
                            üè† Back to Menu
                        </button>
                    </div>
                </div>
            `;
        }
        
        async function submitStudentInfo() {
            console.log('üìù Submit student info clicked');
            
            // FIRST: Ensure currentGame and players array exist
            if (!currentGame) {
                console.error('‚ùå No current game found');
                showError('submit-error', 'Game session lost. Please try joining again.');
                return;
            }
            
            if (!currentGame.players) {
                currentGame.players = [];
                console.log('Created empty players array');
            }
            
            const name = document.getElementById('student-name').value.trim();
            const fact = document.getElementById('student-fact').value.trim();
            
            console.log('Student info:', { name, fact });
            console.log('Current game state:', currentGame);
            
            if (!name || !fact) {
                showError('submit-error', 'Please enter both your name and fun fact');
                return;
            }
            
            if (name.length < 2) {
                showError('submit-error', 'Name must be at least 2 characters');
                return;
            }
            
            if (fact.length < 10) {
                showError('submit-error', 'Fun fact must be at least 10 characters');
                return;
            }
            
            // Now safely check for existing players
            const existingPlayer = currentGame.players.find(p => p.name.toLowerCase() === name.toLowerCase());
            if (existingPlayer) {
                showError('submit-error', 'Someone with that name has already joined!');
                return;
            }
            
            const newPlayer = {
                id: Date.now(),
                name: name,
                fact: fact,
                joinedAt: new Date().toISOString()
            };
            
            console.log('Adding player:', newPlayer);
            
            currentGame.players.push(newPlayer);
            console.log('Updated players array:', currentGame.players);
            
            try {
                const saved = await saveGameToFirebase(gameCode, currentGame);
                console.log('Save result:', saved);
                
                if (saved) {
                    console.log('‚úÖ Successfully joined game');
                    showStudentWaiting();
                } else {
                    console.log('‚ùå Failed to save to Firebase');
                    showError('submit-error', 'Failed to join game. Please try again.');
                }
            } catch (error) {
                console.error('‚ùå Error saving player:', error);
                showError('submit-error', 'Error joining game. Please try again.');
                // Also log the full error for debugging
                console.error('Full error details:', error.stack);
            }
        }
        
        function showStudentWaiting() {
            console.log('‚è≥ Showing student waiting screen');
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="no-scroll bg-gradient-to-br from-green-600 via-teal-600 to-blue-600 flex items-center justify-center p-4">
                    <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full text-center">
                        <div class="text-6xl mb-4">‚úÖ</div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">You're In!</h2>
                        <p class="text-lg text-gray-600 mb-4">Successfully joined the game</p>
                        <p class="text-sm text-gray-500 mb-6">Game Code: <strong>${gameCode}</strong></p>
                        <div class="bg-blue-50 p-4 rounded-2xl mb-6">
                            <p class="text-lg font-semibold text-blue-800">Waiting for teacher to start the game...</p>
                        </div>
                        <div class="w-12 h-12 mx-auto bg-blue-500 rounded-full animate-pulse"></div>
                    </div>
                </div>
            `;
            
            // Start checking for game updates
            checkGameStatus();
        }
        
        async function checkGameStatus() {
            const latestGame = await loadGameFromFirebase(gameCode);
            
            if (latestGame) {
                currentGame = latestGame;
                
                if (latestGame.isStarted && latestGame.gamePhase === 'playing') {
                    showStudentGameView();
                    return;
                } else if (latestGame.gamePhase === 'finished') {
                    showStudentResults();
                    return;
                }
            }
            
            // Keep checking every 2 seconds
            setTimeout(checkGameStatus, 2000);
        }
        
        function showStudentGameView() {
            if (!currentGame.questions || currentGame.currentQuestion >= currentGame.questions.length) {
                return;
            }
            
            const question = currentGame.questions[currentGame.currentQuestion];
            const questionNum = currentGame.currentQuestion + 1;
            const totalQuestions = currentGame.questions.length;
            
            // If student already answered this question, show waiting screen
            if (studentAnswerSubmitted) {
                showAnswerReceivedScreen();
                return;
            }
            
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="game-screen bg-gradient-to-br from-purple-600 via-pink-600 to-red-600 p-4">
                    <div class="max-w-md mx-auto">
                        <div class="bg-white rounded-3xl shadow-2xl p-6">
                            <div class="text-center mb-6">
                                <div class="bg-gradient-to-r from-blue-500 to-purple-500 text-white px-4 py-2 rounded-2xl text-sm font-bold mb-4">
                                    Question ${questionNum}/${totalQuestions}
                                </div>
                                <div class="text-lg font-bold text-gray-800">Look at the main screen for the question!</div>
                                <div class="text-sm text-gray-600 mt-2">Choose your answer below:</div>
                            </div>
                            
                            <div class="flex justify-center mb-6">
                                <div class="w-16 h-16 rounded-full flex items-center justify-center text-xl font-bold ${currentGame.timeLeft <= 5 ? 'bg-red-500' : 'bg-gradient-to-r from-green-400 to-blue-500'} text-white">
                                    ${currentGame.timeLeft || 15}
                                </div>
                            </div>
                            
                            <div class="space-y-3">
                                ${question.options.map((option, index) => `
                                    <button onclick="submitStudentAnswer(${index})" 
                                            class="w-full p-4 rounded-2xl font-semibold text-lg transition-all duration-200 ${getStudentOptionStyle(index)}"
                                            ${currentGame.timeLeft <= 0 ? 'disabled' : ''}>
                                        <span class="text-2xl font-bold mr-3">${getOptionLetter(index)}</span>
                                        ${option}
                                    </button>
                                `).join('')}
                            </div>
                            
                            <div class="mt-6 text-center">
                                <div class="bg-gray-100 px-4 py-2 rounded-xl">
                                    <span class="text-sm text-gray-600">Your Score: </span>
                                    <span class="font-bold text-gray-800">${score}/${Math.max(0, questionNum - 1)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Continue checking for updates
            setTimeout(checkGameStatus, 2000);
        }
        
        function getStudentOptionStyle(index) {
            const styles = [
                'bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white shadow-md',
                'bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white shadow-md',
                'bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white shadow-md',
                'bg-gradient-to-r from-yellow-500 to-yellow-600 hover:from-yellow-600 hover:to-yellow-700 text-white shadow-md'
            ];
            return styles[index] || 'bg-gray-500 text-white shadow-md';
        }
        
        function submitStudentAnswer(selectedIndex) {
            const question = currentGame.questions[currentGame.currentQuestion];
            
            // Mark as answered
            studentAnswerSubmitted = true;
            
            // Update score locally
            if (selectedIndex === question.correctIndex) {
                score++;
            }
            
            // Store the selected answer
            const selectedAnswer = question.options[selectedIndex];
            
            // Show answer received screen immediately
            showAnswerReceivedScreen(selectedAnswer);
        }
        
        function showAnswerReceivedScreen(selectedAnswer) {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="no-scroll bg-gradient-to-br from-green-600 via-emerald-600 to-teal-600 flex items-center justify-center p-4">
                    <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full text-center">
                        <div class="text-6xl mb-6">üìù</div>
                        <h2 class="text-3xl font-bold text-gray-800 mb-4">Answer Received!</h2>
                        <p class="text-lg text-gray-600 mb-6">Your answer has been submitted successfully.</p>
                        
                        ${selectedAnswer ? `
                            <div class="bg-emerald-100 p-4 rounded-2xl mb-6 border-2 border-emerald-300">
                                <div class="text-sm text-gray-600 mb-2">Your answer:</div>
                                <div class="text-xl font-bold text-emerald-800">${selectedAnswer}</div>
                            </div>
                        ` : ''}
                        
                        <div class="bg-yellow-50 p-4 rounded-2xl mb-6 border border-yellow-200">
                            <p class="text-sm text-gray-700 mb-2">‚úã Please wait for the teacher to:</p>
                            <p class="text-sm font-semibold text-orange-700">‚Ä¢ Show the correct answer</p>
                            <p class="text-sm font-semibold text-orange-700">‚Ä¢ Move to the next question</p>
                        </div>
                        
                        <div class="mt-6">
                            <div class="w-16 h-16 mx-auto bg-emerald-500 rounded-full flex items-center justify-center text-white text-2xl font-bold animate-pulse">
                                ‚è≥
                            </div>
                            <p class="text-lg text-gray-600 mt-4 font-semibold">Waiting for teacher...</p>
                        </div>
                    </div>
                </div>
            `;
            
            // Continue checking for next question
            setTimeout(checkGameStatus, 3000);
        }
        
        function showStudentResults() {
            const totalQuestions = currentGame.questions.length;
            const percentage = Math.round((score / totalQuestions) * 100);
            
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="game-screen bg-gradient-to-br from-yellow-600 via-orange-600 to-red-600 flex items-center justify-center p-4">
                    <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full text-center">
                        <div class="mb-8">
                            <div class="bg-gradient-to-r from-yellow-400 to-orange-500 rounded-full w-20 h-20 flex items-center justify-center mx-auto mb-4 text-4xl">
                                üèÜ
                            </div>
                            <h2 class="text-3xl font-bold text-gray-800 mb-2">Game Complete!</h2>
                        </div>
                        
                        <div class="space-y-6">
                            <div class="bg-gradient-to-r from-yellow-100 to-orange-100 p-6 rounded-2xl">
                                <h3 class="text-2xl font-bold text-gray-800 mb-2">Your Score</h3>
                                <div class="text-5xl font-bold text-orange-600 mb-2">${score}</div>
                                <div class="text-lg text-gray-600">out of ${totalQuestions} questions</div>
                                <div class="text-2xl font-semibold text-gray-800 mt-2">${percentage}%</div>
                            </div>
                            
                            <div class="flex justify-center text-6xl">
                                ${percentage >= 80 ? 'üèÜ' : percentage >= 60 ? 'ü•à' : percentage >= 40 ? 'ü•â' : 'üéØ'}
                            </div>
                            
                            <p class="text-lg text-gray-600">
                                ${percentage >= 80 ? 'Amazing! You really know your classmates!' :
                                  percentage >= 60 ? 'Great job! You know your classmates well.' :
                                  percentage >= 40 ? 'Not bad! There\'s still more to learn.' :
                                  'Time to get to know your classmates better!'}
                            </p>
                            
                            <button onclick="renderMenu()" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-semibold py-4 px-6 rounded-2xl transition-all duration-300 transform hover:scale-105 shadow-lg">
                                üè† Play Again
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Global function assignments
        window.renderMenu = renderMenu;
        window.startTeacherFlow = startTeacherFlow;
        window.startStudentFlow = startStudentFlow;
        window.createGame = createGame;
        window.startGame = startGame;
        window.joinGame = joinGame;
        window.submitStudentInfo = submitStudentInfo;
        window.nextQuestion = nextQuestion;
        window.endGame = endGame;
        window.submitStudentAnswer = submitStudentAnswer;
        window.showJoinSuccess = showJoinSuccess;
        
        // Initialize
        function init() {
            const urlParams = new URLSearchParams(window.location.search);
            const codeParam = urlParams.get('code');
            
            if (codeParam) {
                gameCode = codeParam.toUpperCase();
                setTimeout(() => {
                    startStudentFlow();
                    setTimeout(() => {
                        const input = document.getElementById('game-code-input');
                        if (input) input.value = gameCode;
                    }, 100);
                }, 100);
            } else {
                setTimeout(renderMenu, 500);
            }
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
